<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Kernel Adventures</title><meta name=description content="Collection of posts about things I learn and try to explain: hacking, code, backend, aws, devops, devsecops and whatever I find interesting"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=https://dporras.io.gt/css/bootstrap.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic"><link rel=stylesheet href=https://dporras.io.gt/css/font-awesome.min.css><link rel=stylesheet href=https://dporras.io.gt/css/owl.carousel.css><link rel=stylesheet href=https://dporras.io.gt/css/owl.theme.css><link href=https://dporras.io.gt/css/style.pink.css rel=stylesheet id=theme-stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link href=https://dporras.io.gt/css/custom.css rel=stylesheet><link rel="shortcut icon" href=https://dporras.io.gt/img/favicon.png></head><body><div id=all><div class=container-fluid><div class="row row-offcanvas row-offcanvas-left"><div id=sidebar class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas"><div class=sidebar-content><h1 class=sidebar-heading><a href=https://dporras.io.gt/>dporras.io.gt</a></h1><p class=sidebar-p>AppSec Engineer that loves coding & pentest. AWS fanboy, DevSecOps apprentice. #Cloud #Automation #Hacking #AppSec #Python #DevSecOps #Coffee #OfCourseMoreCoffee</p><ul class=sidebar-menu><li><a href=https://dporras.io.gt/posts/>Home</a></li><li><a href=https://dporras.io.gt/about/>About</a></li><li><a href=https://dporras.io.gt/contact/>Get in touch</a></li></ul><p class=social><a href=mailto:dporras.mail@gmail.com data-animate-hover=pulse class=email><i class="fa fa-envelope"></i></a>
<a href=https://github.com/dporr data-animate-hover=pulse class=external><i class="fa fa-github"></i></a></p><div class=copyright><p class=credit>&copy;2020 Diego Porras - Actually copy and reproduce whatever you want. DRM Free :D |
Template by <a href=https://bootstrapious.com/free-templates class=external>Bootstrapious.com</a>
& ported to Hugo by <a href=https://github.com/kishaningithub>Kishan B</a></p></div></div></div><div class="col-xs-12 col-sm-8 col-md-9 content-column white-background"><div class="small-navbar visible-xs"><button type=button data-toggle=offcanvas class="btn btn-ghost pull-left"> <i class="fa fa-align-left"></i>Menu</button><h1 class=small-navbar-heading><a href=https://dporras.io.gt/>dporras.io.gt</a></h1></div><div class=row><div class=col-lg-8><div class=content-column-content><h1>Kernel Adventures</h1><p>Tile image source: <a href=https://static.lwn.net/images/pdf/LDD3/ch01.pdf>https://static.lwn.net/images/pdf/LDD3/ch01.pdf</a></p><h3 id=how-much-about-linux-kernel-can-be-learned-in-30-days>How much about linux kernel can be learned in 30 days?</h3><p>Let&rsquo;s find out.</p><p>The content for the series comes mainly from 2 resources used in no particualr order.</p><p>Linux Device Drivers, Third Edition. Freely available here <a href=https://lwn.net/Kernel/LDD3/>https://lwn.net/Kernel/LDD3/</a>
Hamburg&rsquo;s university - Advent(2) - <a href=https://osg.tuhh.de/Advent/>https://osg.tuhh.de/Advent/</a></p><p>Each day I wil publish a list of lessons learned from the linked material, any additional resources I used and things that were particularly interesting while doing the practical parts.</p><h4 id=day-1-ch1-an-introduction-to-device-drivershttpsstaticlwnnetimagespdfldd3ch01pdf>Day 1: <a href=https://static.lwn.net/images/pdf/LDD3/ch01.pdf>CH1: An introduction to device drivers</a></h4><p><em>&ldquo;The Linux kernel remains a
large and complex body of code, however, and would-be kernel hackers need an
entry point where they can approach the code without being overwhelmed by com-
plexity. Often, device drivers provide that gateway&rdquo;</em></p><p>Take aways:</p><ul><li>The kernel functionality can be roughly classified as:<ul><li>Process management</li><li>Memory management</li><li>Filesystems</li><li>Device control</li><li>Networking</li></ul></li></ul><ul><li>Device drivers could be of mainly 3 types (There are other more specialized types):<ul><li>Char modules</li><li>Block modules</li><li>Network modules</li></ul></li></ul><ul><li>In linux a module is a hot-pluggable piece of object code. Usualy resulting from
the compilation of a device driver, ie. Char module == Char device driver</li></ul><h5 id=day-2-3-skipped>Day 2, 3: Skipped.</h5><h4 id=day-4-open-syscallhttpsosgtuhhdeadvent01-open>Day 4: <a href=https://osg.tuhh.de/Advent/01-open/>open syscall</a></h4><p><em>" Although the kernel has objects somewhat similar to FILE*s, it doesn’t give applications direct access to those objects. Instead, an array called the file descriptor table stores an array of such objects. The file descriptors that applications manipulate are indexes into this table. It’s very easy to check that an integer is in bounds.)"</em></p><p>Take aways:</p><ul><li>The kernel receive integers for file descriptors and not direct pointers to files.</li></ul><ul><li>FD are mapped on the <a href="https://cs61.seas.harvard.edu/site/ref/file-descriptors/#gsc.tab=0"><code>fdtable</code></a> and return a <a href=https://elixir.bootlin.com/linux/v5.16/source/include/linux/fs.h#L962><code>file struct</code></a> The file struct is the actual manipulable file object.</li></ul><ul><li>Zero a buffer with memset(BUFFER, 0, BUFF_SIZE)</li></ul><h3 id=day-4-easter-egg---outro>Day 4 Easter egg - Outro</h3><p>During testing of muy solution I found that my <code>cat</code> program was writting junk when invoked with <code>make run</code> or <code>./cat cat.c MakeFile</code>. This was caused by a previously innitialized buffer <del>the initial file being larger than the second one and thus I was writting to STDOUT the contents of the second file (MakeFile) + junk from the previous buffer contents.</del> To solve this I did 2 things:</p><ol><li>Debugged with GDB to see how the buffer was populated</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>file</span> <span style=color:#66d9ef>cat</span> 
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>gdb</span>) <span style=color:#66d9ef>disassemble</span> <span style=color:#66d9ef>main</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555204</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>91</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>esi</span>,<span style=color:#ae81ff>0x0</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555209</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>96</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>rdi</span>,<span style=color:#66d9ef>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555520c</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>99</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>eax</span>,<span style=color:#ae81ff>0x0</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555211</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>104</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>call</span>   <span style=color:#ae81ff>0x5555555550b0</span> &lt;<span style=color:#66d9ef>open@plt</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555216</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>109</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>DWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rip</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x3e24</span>],<span style=color:#66d9ef>eax</span>        <span style=color:#75715e># 0x555555559040 &lt;fd&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555521c</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>115</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jmp</span>    <span style=color:#ae81ff>0x555555555237</span> &lt;<span style=color:#66d9ef>main</span>+<span style=color:#ae81ff>142</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555521e</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>117</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>edx</span>,<span style=color:#ae81ff>0x1000</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555223</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>122</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#66d9ef>rax</span>,[<span style=color:#66d9ef>rip</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x2e16</span>]        <span style=color:#75715e># 0x555555558040 &lt;buff&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555522a</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>129</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>rsi</span>,<span style=color:#66d9ef>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555522d</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>132</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>edi</span>,<span style=color:#ae81ff>0x1</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555232</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>137</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>call</span>   <span style=color:#ae81ff>0x555555555080</span> &lt;<span style=color:#66d9ef>write@plt</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555237</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>142</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>eax</span>,<span style=color:#66d9ef>DWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rip</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x3e03</span>]        <span style=color:#75715e># 0x555555559040 &lt;fd&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555523d</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>148</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>edx</span>,<span style=color:#ae81ff>0x1000</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555242</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>153</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#66d9ef>rcx</span>,[<span style=color:#66d9ef>rip</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x2df7</span>]        <span style=color:#75715e># 0x555555558040 &lt;buff&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555249</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>160</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>rsi</span>,<span style=color:#66d9ef>rcx</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555524c</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>163</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>edi</span>,<span style=color:#66d9ef>eax</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555524e</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>165</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>call</span>   <span style=color:#ae81ff>0x5555555550a0</span> &lt;<span style=color:#66d9ef>read@plt</span>&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>=&gt;</span> <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555253</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>170</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>test</span>   <span style=color:#66d9ef>rax</span>,<span style=color:#66d9ef>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555256</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>173</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jne</span>    <span style=color:#ae81ff>0x55555555521e</span> &lt;<span style=color:#66d9ef>main</span>+<span style=color:#ae81ff>117</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555258</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>175</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>add</span>    <span style=color:#66d9ef>DWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rbp-0xc</span>],<span style=color:#ae81ff>0x1</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555525c</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>179</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>eax</span>,<span style=color:#66d9ef>DWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rbp-0xc</span>]
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555525f</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>182</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>cmp</span>    <span style=color:#66d9ef>eax</span>,<span style=color:#66d9ef>DWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rbp-0x14</span>]
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555262</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>185</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jl</span>     <span style=color:#ae81ff>0x5555555551c8</span> &lt;<span style=color:#66d9ef>main</span>+<span style=color:#ae81ff>31</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555268</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>191</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>eax</span>,<span style=color:#ae81ff>0x0</span>
</span></span></code></pre></div><p>In &lt;main+170> the return value of read its checked for 0. If 0 is found then we are done reading the file and can continue to program exit routine on &lt;main+175>, otherwise we go back to the start of the loop at &lt;main+117>.</p><h3 id=calling-write>Calling write</h3><p>In &lt;main+117> we are setting EDX to 0x1000. That&rsquo;s the buffer size DEC 4096 in hex and loading the address of our buffer into RAX and passing that as argument to <code>write</code> by moving it to RSI. Finally we pass the file descriptro in the EDI register. Here 0x1 corresponds to the FD of STDOUT&mldr; Then Write is called.</p><h3 id=calling-read>Calling read</h3><p>This follows the same convention and basically we are passing the following arguments FD, BUFF_SIZE, BUFF
in inverse order. The value of FD is the return value of &lt;main+104> in EAX and stored in memory at [rip+0x3e24] (As this is a relative offset to RIP that is changing during retrieval the offset may change), then this is retrieved from [rip+0x3e03] and passed into EAX again, the next intruction puts DEC 4096 in RDX. The next 2 instructions put the address to the buffer into RSI, and finally the FD ends in EDI as per convention</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555237</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>142</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>eax</span>,<span style=color:#66d9ef>DWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rip</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x3e03</span>]        <span style=color:#75715e># 0x555555559040 &lt;fd&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555523d</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>148</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>edx</span>,<span style=color:#ae81ff>0x1000</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555242</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>153</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#66d9ef>rcx</span>,[<span style=color:#66d9ef>rip</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x2df7</span>]        <span style=color:#75715e># 0x555555558040 &lt;buff&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555249</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>160</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>rsi</span>,<span style=color:#66d9ef>rcx</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555524c</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>163</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#66d9ef>edi</span>,<span style=color:#66d9ef>eax</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000055555555524e</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>165</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>call</span>   <span style=color:#ae81ff>0x5555555550a0</span> &lt;<span style=color:#66d9ef>read@plt</span>&gt;
</span></span></code></pre></div><p>For more details on how syscalls parameters are passed see: <a href=https://x64.syscall.sh/>https://x64.syscall.sh/</a></p><p>So basically printing the buffer contets every time</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>=&gt;</span> <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000555555555253</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>170</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>test</span>   <span style=color:#66d9ef>rax</span>,<span style=color:#66d9ef>rax</span>
</span></span></code></pre></div><p>was reached showed that the buffer was corrput from the previous iteration</p><ol start=2><li>Zeroed the buffer after each iteration: <code>memset(buff, 0, BUFF_SIZE)</code></li></ol><h4 id=day-5-ch2--building-and-running-moduleshttpsstaticlwnnetimagespdfldd3ch02pdf>Day 5: <a href=https://static.lwn.net/images/pdf/LDD3/ch02.pdf>CH2: Building and running modules</a></h4><p>This chapter includes a nice reference to header fields, macros & functions that are required as the basis for any module.</p><p>Take aways:</p><ul><li><code>insmod</code> uses the <code>sys_init_module</code> system call defined on <code>kernel/module.c</code>. sys_init_module allocates kernel memory using <code>vmalloc</code>.</li></ul><ul><li>Must have concurrency in mind when writting kernel code</li><li>allocate vs register: Things are only available to kernel after registering them, allocation must happen before.</li></ul><ul><li>Modules need, at least, the following headers<ul><li>#include &lt;linux/module.h></li><li>#include &lt;linux/init.h></li></ul></li></ul><ul><li>Modules use definitions like<ul><li>MODULE_AUTHOR</li><li>MODULE_DESCRIPTION</li><li>MODULE_VERSION</li><li>MODULE_ALIAS</li><li>MODULE_DEVICE_TABLE</li></ul></li></ul><ul><li><code>modprobe</code> does additional symbol resolution searching for additional modules and object files on its default path, on the contrary using <code>insmod</code> all the individual modules that make a driver need to be loaded explicitly</li></ul><ul><li>Module initialization</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>initialization_function</span>(<span style=color:#66d9ef>void</span>){
</span></span><span style=display:flex><span>   <span style=color:#75715e>/*Function body*/</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>module_init</span>(initialization_function);
</span></span></code></pre></div><ul><li>Module cleanup</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> __exit <span style=color:#a6e22e>cleanup</span>(<span style=color:#66d9ef>void</span>){
</span></span><span style=display:flex><span>   <span style=color:#75715e>/*Function body*/</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>module_exit</span>(cleanup);
</span></span></code></pre></div><h4 id=strategies-for-module-cleanup>Strategies for module cleanup.</h4><ul><li>using goto</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> __init <span style=color:#a6e22e>my_init_function</span>(<span style=color:#66d9ef>void</span>){
</span></span><span style=display:flex><span>   <span style=color:#75715e>/*Registration takes a pointer and a name*/</span>
</span></span><span style=display:flex><span>   err <span style=color:#f92672>=</span> <span style=color:#a6e22e>register_this</span>(ptr1, <span style=color:#e6db74>&#34;item 1&#34;</span>);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>(err) <span style=color:#66d9ef>goto</span> fail_this;
</span></span><span style=display:flex><span>   err <span style=color:#f92672>=</span> <span style=color:#a6e22e>register_that</span>(ptr2, <span style=color:#e6db74>&#34;second facility&#34;</span>);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>(err) <span style=color:#66d9ef>goto</span> fail_that;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fail_that: <span style=color:#a6e22e>unregister_that</span>(ptr2,<span style=color:#e6db74>&#34;second facilitt&#34;</span>);
</span></span><span style=display:flex><span>fail_this: <span style=color:#a6e22e>unregister_this</span>(ptr1, <span style=color:#e6db74>&#34;item 1&#34;</span>);
</span></span></code></pre></div><ul><li>keeping track of initialization</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> something <span style=color:#f92672>*</span>item1;
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> somethingelse <span style=color:#f92672>*</span>item2;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> stuff_ok;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>my_cleanup</span>(<span style=color:#66d9ef>void</span>){
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>(item1) 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>release_thing</span>(item1);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>(item2)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>release_thing</span>(item2);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>(stuff_ok)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>unregister_stuff</span>();
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>my_init</span>(<span style=color:#66d9ef>void</span>){
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>int</span> err <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>ENOMEM;
</span></span><span style=display:flex><span>   item1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>allocate_thing</span>(arguments);
</span></span><span style=display:flex><span>   item2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>allocate_thing2</span>(arguments);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>item1 <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>item2)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>goto</span> fail;
</span></span><span style=display:flex><span>   err <span style=color:#f92672>=</span> <span style=color:#a6e22e>register_stuff</span>(item1, item2);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>err)
</span></span><span style=display:flex><span>      stuff_ok <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>goto</span> fail;
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   fail:
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>my_cleanup</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> err;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div></div></div></div></div></div><script src=https://dporras.io.gt/js/jquery.min.js></script>
<script src=https://dporras.io.gt/js/bootstrap.min.js></script>
<script src=https://dporras.io.gt/js/jquery.cookie.js></script><script src=https://dporras.io.gt/js/ekko-lightbox.js></script>
<script src=https://dporras.io.gt/js/jquery.scrollTo.min.js></script>
<script src=https://dporras.io.gt/js/masonry.pkgd.min.js></script>
<script src=https://dporras.io.gt/js/imagesloaded.pkgd.min.js></script>
<script src=https://dporras.io.gt/js/owl.carousel.min.js></script>
<script src=https://dporras.io.gt/js/front.js></script></body></html>