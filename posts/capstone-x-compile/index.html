<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Cross-compiling libcapstone correctly</title><meta name=description content="Collection of posts about things I learn and try to explain: hacking, code, backend, aws, devops, devsecops and whatever I find interesting"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=http://aleph.theartofhacking.club/css/bootstrap.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic"><link rel=stylesheet href=http://aleph.theartofhacking.club/css/font-awesome.min.css><link rel=stylesheet href=http://aleph.theartofhacking.club/css/owl.carousel.css><link rel=stylesheet href=http://aleph.theartofhacking.club/css/owl.theme.css><link href=http://aleph.theartofhacking.club/css/style.pink.css rel=stylesheet id=theme-stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link href=http://aleph.theartofhacking.club/css/custom.css rel=stylesheet><link rel="shortcut icon" href=http://aleph.theartofhacking.club/img/favicon.png></head><body><div id=all><div class=container-fluid><div class="row row-offcanvas row-offcanvas-left"><div id=sidebar class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas"><div class=sidebar-content><h1 class=sidebar-heading><a href=http://aleph.theartofhacking.club/>The Art of hacking - blog</a></h1><p class=sidebar-p>AppSec Engineer. Trying to do low level stuff</p><ul class=sidebar-menu><li><a href=http://aleph.theartofhacking.club/posts/>Home</a></li><li><a href=http://aleph.theartofhacking.club/about/>About</a></li><li><a href=http://aleph.theartofhacking.club/contact/>Get in touch</a></li></ul><p class=social><a href=mailto:diego.porras@owasp.org data-animate-hover=pulse class=email><i class="fa fa-envelope"></i>
</a><a href=https://github.com/dporr data-animate-hover=pulse class=external><i class="fa fa-github"></i></a></p><div class=copyright><p class=credit>&copy;2023 Diego Porras - Actually copy and reproduce whatever you want. DRM Free :D |
Template by <a href=https://bootstrapious.com/free-templates class=external>Bootstrapious.com</a>
& ported to Hugo by <a href=https://github.com/kishaningithub>Kishan B</a></p></div></div></div><div class="col-xs-12 col-sm-8 col-md-9 content-column white-background"><div class="small-navbar visible-xs"><button type=button data-toggle=offcanvas class="btn btn-ghost pull-left"> <i class="fa fa-align-left"></i>Menu</button><h1 class=small-navbar-heading><a href=http://aleph.theartofhacking.club/>The Art of hacking - blog</a></h1></div><div class=row><div class=col-lg-8><div class=content-column-content><h1>Cross-compiling libcapstone correctly</h1><h4 id=tldr>TL;DR</h4><p>x-compile libcapstone.so.4 in an x86 host and pass it to qemu-user aarch64 to run binaries that have a dependency on capstone</p><h3 id=x-compile-libcapstone-for-aarch64>X-Compile libcapstone for Aarch64</h3><p>Note: this post assumes you have a toolchain for aarch64, you can install it with
<code>sudo apt install crossbuild-essential-arm64</code>, this will create the route <code>/usr/lib/aarch64-linux-gnu/</code> where our cross-compiled libraries will live. That package alos gives you the cross-platform toolchain prefixed with <code>/usr/bin/aarch64-linux-gnu-</code></p><p>Seems that capstone/cmake won&rsquo;t respect your <code>CC</code>, <code>CXX</code> variables when cross-compiling. This is how I got libcapstone cross-compiled Host: x86, target: aarch64</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo CROSS<span style=color:#f92672>=</span>/usr/bin/aarch64-linux-gnu- CAPSTONE_ARCHS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;aarch64&#34;</span> ./make.sh install 
</span></span></code></pre></div><p>They have that <code>CROSS</code> variable and I gave it a try, turns out it works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ file /usr/lib/libcapstone.so.4 
</span></span><span style=display:flex><span>/usr/lib/libcapstone.so.4: ELF 64-bit LSB shared object, ARM aarch64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>SYSV<span style=color:#f92672>)</span>, dynamically linked, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>e44f40ba64cbe01071992d33111a997d2a151d9e, not stripped
</span></span></code></pre></div><p>And this is how you run the bins inside qemu-user or &ldquo;locally&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#You need these two libs cross-compiled</span>
</span></span><span style=display:flex><span>churro@pwn:~/Desktop/ARM$ ls /usr/aarch64-linux-gnu/lib/ld-linux-aarch64.so.1 /usr/aarch64-linux-gnu/lib/libcapstone.so.4 
</span></span><span style=display:flex><span>/usr/aarch64-linux-gnu/lib/ld-linux-aarch64.so.1  /usr/aarch64-linux-gnu/lib/libcapstone.so.4
</span></span><span style=display:flex><span><span style=color:#75715e>#Then just qemu-user the planet </span>
</span></span><span style=display:flex><span>churro@pwn:~/Desktop/ARM$ qemu-aarch64 -L /usr/aarch64-linux-gnu/  level-1-0 
</span></span></code></pre></div></div></div></div></div></div></div></div><script src=http://aleph.theartofhacking.club/js/jquery.min.js></script><script src=http://aleph.theartofhacking.club/js/bootstrap.min.js></script><script src=http://aleph.theartofhacking.club/js/jquery.cookie.js></script><script src=http://aleph.theartofhacking.club/js/ekko-lightbox.js></script><script src=http://aleph.theartofhacking.club/js/jquery.scrollTo.min.js></script><script src=http://aleph.theartofhacking.club/js/masonry.pkgd.min.js></script><script src=http://aleph.theartofhacking.club/js/imagesloaded.pkgd.min.js></script><script src=http://aleph.theartofhacking.club/js/owl.carousel.min.js></script><script src=http://aleph.theartofhacking.club/js/front.js></script></body></html>