<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Posts</title><meta name=description content="Collection of posts about things I learn and try to explain: hacking, code, backend, aws, devops, devsecops and whatever I find interesting"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=http://aleph.theartofhacking.club/css/bootstrap.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic"><link rel=stylesheet href=http://aleph.theartofhacking.club/css/font-awesome.min.css><link rel=stylesheet href=http://aleph.theartofhacking.club/css/owl.carousel.css><link rel=stylesheet href=http://aleph.theartofhacking.club/css/owl.theme.css><link href=http://aleph.theartofhacking.club/css/style.pink.css rel=stylesheet id=theme-stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link href=http://aleph.theartofhacking.club/css/custom.css rel=stylesheet><link rel="shortcut icon" href=http://aleph.theartofhacking.club/img/favicon.png><link href=http://aleph.theartofhacking.club/posts/index.xml rel=alternate type=application/rss+xml title="The Art of hacking - blog"></head><body><div id=all><div class=container-fluid><div class="row row-offcanvas row-offcanvas-left"><div id=sidebar class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas"><div class=sidebar-content><h1 class=sidebar-heading><a href=http://aleph.theartofhacking.club/>The Art of hacking - blog</a></h1><p class=sidebar-p>AppSec Engineer. Trying to do low level stuff</p><ul class=sidebar-menu><li><a href=http://aleph.theartofhacking.club/posts/>Home</a></li><li><a href=http://aleph.theartofhacking.club/about/>About</a></li><li><a href=http://aleph.theartofhacking.club/contact/>Get in touch</a></li></ul><p class=social><a href=mailto:diego.porras@owasp.org data-animate-hover=pulse class=email><i class="fa fa-envelope"></i>
</a><a href=https://github.com/dporr data-animate-hover=pulse class=external><i class="fa fa-github"></i></a></p><div class=copyright><p class=credit>&copy;2023 Diego Porras - Actually copy and reproduce whatever you want. DRM Free :D |
Template by <a href=https://bootstrapious.com/free-templates class=external>Bootstrapious.com</a>
& ported to Hugo by <a href=https://github.com/kishaningithub>Kishan B</a></p></div></div></div><div class="col-xs-12 col-sm-8 col-md-9 content-column"><div class="small-navbar visible-xs"><button type=button data-toggle=offcanvas class="btn btn-ghost pull-left"> <i class="fa fa-align-left"></i>Menu</button><h1 class=small-navbar-heading><a href=http://aleph.theartofhacking.club/>The Art of hacking - blog</a></h1></div><div class=grid><div class=row><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 masonry-item"><div class=box-masonry><a href=http://aleph.theartofhacking.club/posts/embedded_notes/ title class="box-masonry-image with-hover-overlay with-hover-icon"><img src=http://aleph.theartofhacking.club/images/tee.png alt class=img-responsive></a><div class=box-masonry-text><h4><a href=http://aleph.theartofhacking.club/posts/embedded_notes/>Build u-boot with trusted firmware for STM32</a></h4><div class=box-masonry-description><p><h4 id=tldr>TL;DR</h4><p>This is a dumbed-down summary of different documentation pieces on u-boot, trusted firmware and STM.
I use this to play around on a local STM board.</p><h3 id=compile-u-boot>Compile U-Boot</h3><p>Docs [1] <a href=https://docs.u-boot.org/en/latest/board/st/index.html>https://docs.u-boot.org/en/latest/board/st/index.html</a></p><ul><li>Chose a config from the supported boards under <code>configs/</code>, in our case <code>configs/stm32mp15_defconfig</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make stm32mp15_defconfig
</span></span></code></pre></div><ul><li>optional customize u-boot features</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make menuconfig
</span></span></code></pre></div><ul><li>chose a device tree from <code>dts/upstream/src/&lt;ARCH>/&lt;VENDOR>/&lt;BOARD></code> in our case <code>stm32mp157a-dk1</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make DEVICE_TREE<span style=color:#f92672>=</span>stm32mp157a-dk1 -j <span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h3 id=compiling-tf-a>Compiling TF-A</h3><p>From TF-A documentation for STM32MP1 [1]</p></p></div></div></div></div><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 masonry-item"><div class=box-masonry><a href=http://aleph.theartofhacking.club/posts/capstone-x-compile/ title class="box-masonry-image with-hover-overlay with-hover-icon"><img src=http://aleph.theartofhacking.club/images/capstone.png alt class=img-responsive></a><div class=box-masonry-text><h4><a href=http://aleph.theartofhacking.club/posts/capstone-x-compile/>Cross-compiling libcapstone correctly</a></h4><div class=box-masonry-description><p><h4 id=tldr>TL;DR</h4><p>x-compile libcapstone.so.4 in an x86 host and pass it to qemu-user aarch64 to run binaries that have a dependency on capstone</p><h3 id=x-compile-libcapstone-for-aarch64>X-Compile libcapstone for Aarch64</h3><p>Seems that capstone/cmake won&rsquo;t respect your <code>CC</code>, <code>CXX</code> variables when cross-compiling. This is how I got libcapstone cross-compiled Host: x86, target: aarch64</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo CROSS<span style=color:#f92672>=</span>/usr/bin/aarch64-linux-gnu- CAPSTONE_ARCHS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;aarch64&#34;</span> ./make.sh install 
</span></span></code></pre></div><p>They have that <code>CROSS</code> variable and I gave it a try, turns out it works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ file /usr/lib/libcapstone.so.4 
</span></span><span style=display:flex><span>/usr/lib/libcapstone.so.4: ELF 64-bit LSB shared object, ARM aarch64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>SYSV<span style=color:#f92672>)</span>, dynamically linked, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>e44f40ba64cbe01071992d33111a997d2a151d9e, not stripped
</span></span></code></pre></div><p>And this is how you run the bins inside qemu-user or &ldquo;locally&rdquo;:</p></p></div></div></div></div></div></div></div></div></div></div><script src=http://aleph.theartofhacking.club/js/jquery.min.js></script><script src=http://aleph.theartofhacking.club/js/bootstrap.min.js></script><script src=http://aleph.theartofhacking.club/js/jquery.cookie.js></script><script src=http://aleph.theartofhacking.club/js/ekko-lightbox.js></script><script src=http://aleph.theartofhacking.club/js/jquery.scrollTo.min.js></script><script src=http://aleph.theartofhacking.club/js/masonry.pkgd.min.js></script><script src=http://aleph.theartofhacking.club/js/imagesloaded.pkgd.min.js></script><script src=http://aleph.theartofhacking.club/js/owl.carousel.min.js></script><script src=http://aleph.theartofhacking.club/js/front.js></script></body></html>