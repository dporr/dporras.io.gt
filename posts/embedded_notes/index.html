<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Build u-boot with trusted firmware for STM32</title><meta name=description content="Collection of posts about things I learn and try to explain: hacking, code, backend, aws, devops, devsecops and whatever I find interesting"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=http://aleph.theartofhacking.club/css/bootstrap.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic"><link rel=stylesheet href=http://aleph.theartofhacking.club/css/font-awesome.min.css><link rel=stylesheet href=http://aleph.theartofhacking.club/css/owl.carousel.css><link rel=stylesheet href=http://aleph.theartofhacking.club/css/owl.theme.css><link href=http://aleph.theartofhacking.club/css/style.pink.css rel=stylesheet id=theme-stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link href=http://aleph.theartofhacking.club/css/custom.css rel=stylesheet><link rel="shortcut icon" href=http://aleph.theartofhacking.club/img/favicon.png></head><body><div id=all><div class=container-fluid><div class="row row-offcanvas row-offcanvas-left"><div id=sidebar class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas"><div class=sidebar-content><h1 class=sidebar-heading><a href=http://aleph.theartofhacking.club/>The Art of hacking - blog</a></h1><p class=sidebar-p>AppSec Engineer. Trying to do low level stuff</p><ul class=sidebar-menu><li><a href=http://aleph.theartofhacking.club/posts/>Home</a></li><li><a href=http://aleph.theartofhacking.club/about/>About</a></li><li><a href=http://aleph.theartofhacking.club/contact/>Get in touch</a></li></ul><p class=social><a href=mailto:diego.porras@owasp.org data-animate-hover=pulse class=email><i class="fa fa-envelope"></i>
</a><a href=https://github.com/dporr data-animate-hover=pulse class=external><i class="fa fa-github"></i></a></p><div class=copyright><p class=credit>&copy;2023 Diego Porras - Actually copy and reproduce whatever you want. DRM Free :D |
Template by <a href=https://bootstrapious.com/free-templates class=external>Bootstrapious.com</a>
& ported to Hugo by <a href=https://github.com/kishaningithub>Kishan B</a></p></div></div></div><div class="col-xs-12 col-sm-8 col-md-9 content-column white-background"><div class="small-navbar visible-xs"><button type=button data-toggle=offcanvas class="btn btn-ghost pull-left"> <i class="fa fa-align-left"></i>Menu</button><h1 class=small-navbar-heading><a href=http://aleph.theartofhacking.club/>The Art of hacking - blog</a></h1></div><div class=row><div class=col-lg-8><div class=content-column-content><h1>Build u-boot with trusted firmware for STM32</h1><h4 id=tldr>TL;DR</h4><p>This is a dumbed-down summary of different documentation pieces on u-boot, trusted firmware and STM.
I use this to play around on a local STM board.</p><h3 id=compile-u-boot>Compile U-Boot</h3><p>Docs [1] <a href=https://docs.u-boot.org/en/latest/board/st/index.html>https://docs.u-boot.org/en/latest/board/st/index.html</a></p><ul><li>Chose a config from the supported boards under <code>configs/</code>, in our case <code>configs/stm32mp15_defconfig</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make stm32mp15_defconfig
</span></span></code></pre></div><ul><li>optional customize u-boot features</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make menuconfig
</span></span></code></pre></div><ul><li>chose a device tree from <code>dts/upstream/src/&lt;ARCH>/&lt;VENDOR>/&lt;BOARD></code> in our case <code>stm32mp157a-dk1</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make DEVICE_TREE<span style=color:#f92672>=</span>stm32mp157a-dk1 -j <span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h3 id=compiling-tf-a>Compiling TF-A</h3><p>From TF-A documentation for STM32MP1 [1]</p><pre tabindex=0><code>make ARM_ARCH_MAJOR=7 ARCH=aarch32 PLAT=stm32mp1 AARCH32_SP=sp_min \
DTB_FILE_NAME=stm32mp157a-dk1.dtb BL33=../u-boot/u-boot-nodtb.bin \
BL33_CFG=../u-boot/u-boot.dtb STM32MP_SDMMC=1 fip all
</code></pre><ul><li>Making sense of the parameters:</li></ul><p><code>ARM_ARCH_MAJOR</code> and <code>ARCH</code> depend on the target device. STM32157C devices thhave a Cortex-A7[3] wich is an aarc32 core compatible with ARMv7-A</p><p><code>PLAT</code> A subfolder under <code>plat/</code> in our case <code>stm32mp1</code></p><p><code>BL33</code> This is the no-secure world bootloader/u-boot in our case</p><p><code>BL33_CFG</code> Device tree for u-boot (since the device tree TF-A is not visible to u-boot running from RAM)</p><p><code>DTB_FILE_NAME</code> device tree under <code>fdts/</code></p><p><code>AARCH32_SP</code> Choose the AArch32 Secure Payload component to be built as as the BL32 image when ARCH=aarch32. The value should be the path to the directory containing the SP source, relative to the bl32/; the directory is expected to contain a makefile called &lt;aarch32_sp-value>.mk.</p><p>[1]https://trustedfirmware-a.readthedocs.io/en/latest/plat/st/index.html</p><p>[2] <a href=https://www.st.com/en/microcontrollers-microprocessors/stm32mp157.html>https://www.st.com/en/microcontrollers-microprocessors/stm32mp157.html</a></p><p>[3] <a href=https://en.wikipedia.org/wiki/ARM_Cortex-A7>https://en.wikipedia.org/wiki/ARM_Cortex-A7</a></p><h3 id=flash-sdcard-for-stm32mp15xx>Flash SDCARD for STM32MP15XX</h3><h4 id=partition-sd-card>Partition SD card</h4><p>We want to create 4 partitions as described in STM docs [1] and U-Boot[2]</p><p>[1] <a href=https://wiki.st.com/stm32mpu/wiki/STM32_MPU_Flash_mapping#SD_card_memory_mapping>https://wiki.st.com/stm32mpu/wiki/STM32_MPU_Flash_mapping#SD_card_memory_mapping</a></p><p>[2] <a href=https://docs.u-boot.org/en/latest/board/st/stm32mp1.html#prepare-an-sd-card>https://docs.u-boot.org/en/latest/board/st/stm32mp1.html#prepare-an-sd-card</a></p><ul><li>Clear existing partitions by zeroing the device</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/dev/your_device bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#no need to clean the whole device,just the begining </span>
</span></span></code></pre></div><ul><li>Create gpt table and 4 partitions. Names and sizes follow convetions in docs [1] and [2]</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo part /dev/your_device
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>part<span style=color:#f92672>)</span> mklabel gpt
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>part<span style=color:#f92672>)</span> mkpart fslb1 0% 1MiB
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>part<span style=color:#f92672>)</span> mkpart fslb2 1MiB 2MiB
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>part<span style=color:#f92672>)</span> mkpart fip 2MiB 4MiB
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>part<span style=color:#f92672>)</span> mkpart bootfs 4MiB 68MiB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>parted<span style=color:#f92672>)</span> print                                                            
</span></span><span style=display:flex><span>Model: Generic- Micro SD/M2 <span style=color:#f92672>(</span>scsi<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Disk /dev/sdb: 31.0GB
</span></span><span style=display:flex><span>Sector size <span style=color:#f92672>(</span>logical/physical<span style=color:#f92672>)</span>: 512B/512B
</span></span><span style=display:flex><span>Partition Table: gpt
</span></span><span style=display:flex><span>Disk Flags: 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Number  Start   End     Size    File system  Name    Flags
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1</span>      17.4kB  1049kB  1031kB               fsbl1
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2</span>      1049kB  2097kB  1049kB               fsbl2
</span></span><span style=display:flex><span> <span style=color:#ae81ff>3</span>      2097kB  4194kB  2097kB               fip
</span></span><span style=display:flex><span> <span style=color:#ae81ff>4</span>      4194kB  71.3MB  67.1MB  ext4         bootfs
</span></span></code></pre></div><p>Note: Use sectors as units, since MiB and MB will generate alignment issues.</p><ul><li>Now, format the boot partition as an ext4 filesystem. This is where U-Boot saves its environment:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo mkfs.ext4 -L boot -O ^metadata_csum /dev/mmcblk0p4
</span></span></code></pre></div><p>The <code>-O ^metadata_csum</code> option allows to create the filesystem without enabling metadata checksums, which
U-Boot doesn’t seem to support yet</p><h4 id=write-the-relevant-binaries>Write the relevant binaries</h4><ul><li>fsbl (BL2) and fsbl2 (backup for BL2) include TF-A</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dd of<span style=color:#f92672>=</span>/dev/sdb1 <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>bootloader/trusted-firmware-a/build/stm32mp1/release/tf-a-stm32mp157a-dk1.stm32 bs<span style=color:#f92672>=</span>1M conv<span style=color:#f92672>=</span>fdatasync
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dd of<span style=color:#f92672>=</span>/dev/sdb2 <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>bootloader/trusted-firmware-a/build/stm32mp1/release/tf-a-stm32mp157a-dk1.stm32 bs<span style=color:#f92672>=</span>1M conv<span style=color:#f92672>=</span>fdatasync
</span></span></code></pre></div><ul><li>The <code>fip</code> is located in partition 3 or a partition named fip check relevant docs for each target</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dd of<span style=color:#f92672>=</span>/dev/sdb3 <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>bootloader/trusted-firmware-a/build/stm32mp1/release/fip.bin  bs<span style=color:#f92672>=</span>1M conv<span style=color:#f92672>=</span>fdatasync
</span></span></code></pre></div><h3 id=serve-kenel-binaries-and-source-from-host-over-tftp>Serve kenel binaries and source from Host over TFTP</h3><h4 id=install--configure-tftp>install & configure TFTP</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install tftpd-hpa
</span></span><span style=display:flex><span>sudo systemctl start tftpd-hpa
</span></span><span style=display:flex><span>sudo cp -r &lt;KERNEL_DIR&gt; /srv/tftp/
</span></span><span style=display:flex><span>sudo chmod -R <span style=color:#ae81ff>777</span> /srv/tftp/
</span></span></code></pre></div><h4 id=always-stop-and-cleanup-the-tftp-server>ALWAYS stop and cleanup the tftp server</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl stop tftpd-hpa
</span></span><span style=display:flex><span>sudo rm -rf /srv/tftp/*
</span></span></code></pre></div></div></div></div></div></div></div></div><script src=http://aleph.theartofhacking.club/js/jquery.min.js></script><script src=http://aleph.theartofhacking.club/js/bootstrap.min.js></script><script src=http://aleph.theartofhacking.club/js/jquery.cookie.js></script><script src=http://aleph.theartofhacking.club/js/ekko-lightbox.js></script><script src=http://aleph.theartofhacking.club/js/jquery.scrollTo.min.js></script><script src=http://aleph.theartofhacking.club/js/masonry.pkgd.min.js></script><script src=http://aleph.theartofhacking.club/js/imagesloaded.pkgd.min.js></script><script src=http://aleph.theartofhacking.club/js/owl.carousel.min.js></script><script src=http://aleph.theartofhacking.club/js/front.js></script></body></html>